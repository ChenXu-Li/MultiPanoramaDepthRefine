# æ·±åº¦å˜åŒ–é‡å¯è§†åŒ–æŒ‡å—

## æ¦‚è¿°

ä¼˜åŒ–å®Œæˆåï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæ·±åº¦å˜åŒ–é‡çƒ­åŠ›å›¾ï¼Œç”¨äºå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ·±åº¦å·®å¼‚ã€‚

## è‡ªåŠ¨ç”Ÿæˆ

è¿è¡Œä¼˜åŒ–è„šæœ¬åï¼Œä¼šåœ¨ä»¥ä¸‹ç›®å½•è‡ªåŠ¨ç”Ÿæˆçƒ­åŠ›å›¾ï¼š

```
outputs/aligned_depths/{scene_name}/depth_diff_heatmaps/
â”œâ”€â”€ {pano_name}_diff_log_diff.png          # logæ·±åº¦å·®ï¼ˆæ¨èï¼‰
â”œâ”€â”€ {pano_name}_diff_log_diff_with_colorbar.png
â”œâ”€â”€ {pano_name}_diff_absolute.png          # ç»å¯¹æ·±åº¦å·®ï¼ˆç±³ï¼‰
â”œâ”€â”€ {pano_name}_diff_absolute_with_colorbar.png
â”œâ”€â”€ {pano_name}_diff_relative.png         # ç›¸å¯¹æ·±åº¦å·®
â””â”€â”€ {pano_name}_diff_relative_with_colorbar.png
```

## ä¸‰ç§å¯¹æ¯”æ–¹å¼

### 1. Log Depth Changeï¼ˆæ¨èï¼‰

**è®¡ç®—æ–¹å¼**ï¼š`|log(depth_after) - log(depth_before)|`

**ä¼˜ç‚¹**ï¼š
- å¯¹ä¸­è¿œæ™¯æ·±åº¦å˜åŒ–æ›´æ•æ„Ÿ
- ä¸å—æ·±åº¦å°ºåº¦å½±å“
- é€‚åˆåˆ†æä¼˜åŒ–æ•ˆæœ

**é€‚ç”¨åœºæ™¯**ï¼šåˆ†ææ•´ä½“ä¼˜åŒ–æ•ˆæœ

### 2. Absolute Depth Change

**è®¡ç®—æ–¹å¼**ï¼š`|depth_after - depth_before|`ï¼ˆå•ä½ï¼šç±³ï¼‰

**ä¼˜ç‚¹**ï¼š
- ç›´è§‚æ˜¾ç¤ºæ·±åº¦å˜åŒ–é‡
- å•ä½æ˜ç¡®ï¼ˆç±³ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦çŸ¥é“å…·ä½“æ·±åº¦å˜åŒ–é‡æ—¶

### 3. Relative Depth Change

**è®¡ç®—æ–¹å¼**ï¼š`|depth_after - depth_before| / depth_before`

**ä¼˜ç‚¹**ï¼š
- å½’ä¸€åŒ–åˆ°ç›¸å¯¹æ¯”ä¾‹
- ä¸å—æ·±åº¦ç»å¯¹å€¼å½±å“

**é€‚ç”¨åœºæ™¯**ï¼šåˆ†æç›¸å¯¹å˜åŒ–æ¯”ä¾‹

## çƒ­åŠ›å›¾è§£è¯»

### é¢œè‰²å«ä¹‰ï¼ˆRdBu_r colormapï¼‰

- **è“è‰²**ï¼šå˜åŒ–é‡å°ï¼ˆä¼˜åŒ–å‰åæ¥è¿‘ï¼‰
- **ç™½è‰²**ï¼šä¸­ç­‰å˜åŒ–
- **çº¢è‰²**ï¼šå˜åŒ–é‡å¤§ï¼ˆä¼˜åŒ–å‰åå·®å¼‚æ˜æ˜¾ï¼‰

### é¢œè‰²æ¡è¯´æ˜

å¸¦é¢œè‰²æ¡çš„ç‰ˆæœ¬åŒ…å«ï¼š
- **Max**ï¼šæœ€å¤§å˜åŒ–é‡ï¼ˆ95åˆ†ä½æ•°ï¼Œé¿å…å¼‚å¸¸å€¼ï¼‰
- **Mean**ï¼šå¹³å‡å˜åŒ–é‡
- **é¢œè‰²æ¡**ï¼šå˜åŒ–é‡èŒƒå›´

## æ‰‹åŠ¨ç”Ÿæˆ

å¦‚æœéœ€è¦å•ç‹¬ç”Ÿæˆæ·±åº¦å˜åŒ–é‡çƒ­åŠ›å›¾ï¼š

```python
from pathlib import Path
from scripts.visualize_depths import visualize_depth_diff_heatmap
from src.utils.io import load_depth_npy

# åŠ è½½ä¼˜åŒ–å‰åçš„æ·±åº¦
depth_before = load_depth_npy("path/to/dap_depth.npy") * 100.0  # è®°å¾—ç¼©æ”¾
depth_after = load_depth_npy("path/to/aligned_depth.npy")

# ç”Ÿæˆçƒ­åŠ›å›¾
visualize_depth_diff_heatmap(
    depth_before=depth_before,
    depth_after=depth_after,
    diff_type="log_diff",  # æˆ– "absolute", "relative"
    cmap="RdBu_r",
    vmax=None,  # è‡ªåŠ¨è®¡ç®—
    save_path=Path("output_diff.png"),
)
```

## åˆ†æå»ºè®®

### 1. æ£€æŸ¥ä¼˜åŒ–æ•ˆæœ

- **è“è‰²åŒºåŸŸå¤š** â†’ ä¼˜åŒ–å‰åå˜åŒ–å°ï¼Œå¯èƒ½å·²æ”¶æ•›
- **çº¢è‰²åŒºåŸŸå¤š** â†’ ä¼˜åŒ–å‰åå˜åŒ–å¤§ï¼Œå¯èƒ½è¿˜éœ€è¦æ›´å¤šè¿­ä»£

### 2. æ£€æŸ¥æƒé‡è®¾ç½®

- **P2RæŸå¤±å·²æ”¶æ•›ä½†ä»æœ‰çº¢è‰²åŒºåŸŸ** â†’ å¯èƒ½éœ€è¦å¢åŠ  `lambda_p2r`
- **æ•´ä½“å˜åŒ–å‡åŒ€** â†’ æƒé‡é…ç½®åˆç†

### 3. æ£€æŸ¥æ”¶æ•›æƒ…å†µ

- **log_diff å¹³å‡ < 0.1** â†’ ä¼˜åŒ–æ•ˆæœè‰¯å¥½
- **log_diff å¹³å‡ > 0.5** â†’ å¯èƒ½æœªå®Œå…¨æ”¶æ•›

## è¾“å‡ºæ–‡ä»¶è¯´æ˜

### åŸºç¡€çƒ­åŠ›å›¾ï¼ˆæ— é¢œè‰²æ¡ï¼‰
- æ–‡ä»¶åï¼š`{pano_name}_diff_{type}.png`
- æ ¼å¼ï¼šPNGï¼ŒRGB
- ç”¨é€”ï¼šå¿«é€ŸæŸ¥çœ‹å˜åŒ–åˆ†å¸ƒ

### å¸¦é¢œè‰²æ¡çš„çƒ­åŠ›å›¾
- æ–‡ä»¶åï¼š`{pano_name}_diff_{type}_with_colorbar.png`
- æ ¼å¼ï¼šPNGï¼ŒåŒ…å«é¢œè‰²æ¡å’Œç»Ÿè®¡ä¿¡æ¯
- ç”¨é€”ï¼šç²¾ç¡®åˆ†æå˜åŒ–é‡æ•°å€¼

## ç¤ºä¾‹è¾“å‡º

```
ğŸ“Š ç”Ÿæˆæ·±åº¦å˜åŒ–é‡çƒ­åŠ›å›¾...
  âœ… point2_median_diff_log_diff.png
  âœ… point2_median_diff_log_diff_with_colorbar.png
  âœ… point2_median_diff_absolute.png
  âœ… point2_median_diff_absolute_with_colorbar.png
  âœ… point2_median_diff_relative.png
  âœ… point2_median_diff_relative_with_colorbar.png
  ...
  âœ… æ·±åº¦å˜åŒ–é‡çƒ­åŠ›å›¾å·²ä¿å­˜åˆ°: outputs/aligned_depths/BridgeB/depth_diff_heatmaps
     åŒ…å«: log_diff, absolute, relative ä¸‰ç§å¯¹æ¯”æ–¹å¼
```

## æ³¨æ„äº‹é¡¹

1. **DAPæ·±åº¦ç¼©æ”¾**ï¼šä¼˜åŒ–å‰çš„æ·±åº¦å·²ç»ç¼©æ”¾100å€ï¼ˆä¸ä¼˜åŒ–è¿‡ç¨‹ä¸€è‡´ï¼‰
2. **æ— æ•ˆåŒºåŸŸ**ï¼šæ— æ•ˆåƒç´ ï¼ˆNaNæˆ–<=0ï¼‰åœ¨çƒ­åŠ›å›¾ä¸­æ˜¾ç¤ºä¸ºé»‘è‰²
3. **è‡ªåŠ¨å½’ä¸€åŒ–**ï¼šä½¿ç”¨95åˆ†ä½æ•°ä½œä¸ºæœ€å¤§å€¼ï¼Œé¿å…å¼‚å¸¸å€¼å½±å“å¯è§†åŒ–
4. **æ–‡ä»¶å¤§å°**ï¼šæ¯ä¸ªçƒ­åŠ›å›¾çº¦ 1-2MBï¼ˆå–å†³äºå›¾åƒå°ºå¯¸ï¼‰

## ä¸æŸå¤±å†å²ç»“åˆåˆ†æ

ç»“åˆæŸå¤±å†å²æ–‡ä»¶ï¼ˆ`logs/loss_history/`ï¼‰å’Œæ·±åº¦å˜åŒ–é‡çƒ­åŠ›å›¾ï¼š

1. **æŸ¥çœ‹æŸå¤±æ›²çº¿**ï¼šäº†è§£ä¼˜åŒ–è¿‡ç¨‹
2. **æŸ¥çœ‹çƒ­åŠ›å›¾**ï¼šäº†è§£ç©ºé—´åˆ†å¸ƒ
3. **è°ƒæ•´æƒé‡**ï¼šæ ¹æ®åˆ†æç»“æœè°ƒæ•´ `lambda_p2r` ç­‰å‚æ•°

ä¾‹å¦‚ï¼š
- å¦‚æœ P2R æŸå¤±å·²æ”¶æ•›ä½†çƒ­åŠ›å›¾ä»æœ‰å¤§é‡çº¢è‰²åŒºåŸŸ â†’ å¢åŠ  `lambda_p2r`
- å¦‚æœçƒ­åŠ›å›¾æ•´ä½“è“è‰²ä½†ç‚¹äº‘æœªå®Œå…¨é‡åˆ â†’ æ£€æŸ¥ç›¸æœºä½å§¿ç²¾åº¦
