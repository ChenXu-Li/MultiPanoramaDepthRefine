# 多视角深度联合优化 - 步骤总结与耗时估算

## 优化流程总览

### 完整流程步骤

```
1. 初始化阶段（~5-10秒）
   ├─ 加载配置文件
   ├─ 加载 COLMAP 重建结果
   └─ 验证数据路径

2. 数据加载阶段（~10-30秒，取决于pano数量）
   ├─ 加载 RGB 图像（每个 ~1-2秒）
   ├─ 加载 DAP 深度图（每个 ~0.5-1秒）
   ├─ 获取相机位姿（每个 ~0.1秒）
   └─ 数据预处理（缩放、log转换）

3. 模型初始化阶段（~5-10秒）
   ├─ 创建深度重参数化模块（每个 ~1-2秒）
   │  ├─ Spline 参数化（单调三次样条，10个节点）
   │  └─ 球面谐波方向缩放（最大4阶）
   └─ 配置优化器（Adam，lr=5e-4）

4. 数据传输阶段（~2-5秒）
   ├─ 将数据移到 GPU/CPU
   └─ 检查内存使用情况

5. 优化循环阶段（主要耗时，~10-60分钟）
   ├─ 每次迭代包含：
   │  ├─ 深度重参数化（~0.05秒/次）
   │  ├─ 计算几何一致性损失（~0.03秒/次）
   │  │  ├─ Point-to-Ray 损失（所有视角对）
   │  │  └─ Ray-space 深度一致性损失
   │  ├─ 计算正则化损失（~0.01秒/次）
   │  │  ├─ 先验锚点损失
   │  │  ├─ 平滑正则损失
   │  │  └─ 方向变形约束损失
   │  ├─ 反向传播（~0.1秒/次）
   │  ├─ 梯度裁剪（~0.01秒/次）
   │  └─ 优化步骤（~0.01秒/次）
   └─ 最多 1000 次迭代（可能提前收敛）

6. 验证阶段（~1-2秒）
   └─ 检查深度合理性

7. 保存结果阶段（~5-10秒）
   └─ 保存优化后的深度图
```

## 详细耗时估算

### 假设条件
- **场景**: BridgeB
- **Pano 数量**: 4个（point2, point3, point4, point5）
- **图像尺寸**: 960×1920（H×W）
- **设备**: GPU (CUDA) 或 CPU

### 分阶段耗时

| 阶段 | 操作 | GPU耗时 | CPU耗时 | 说明 |
|------|------|---------|---------|------|
| **1. 初始化** | 加载配置和COLMAP | ~2秒 | ~2秒 | 一次性操作 |
| **2. 数据加载** | 加载4个pano的数据 | ~10秒 | ~10秒 | 每个pano: RGB(~2s) + 深度(~1s) + 位姿(~0.1s) |
| **3. 模型初始化** | 创建4个重参数化模块 | ~8秒 | ~8秒 | 每个模块: Spline + SH缩放 |
| **4. 数据传输** | 移到GPU/CPU | ~3秒 | ~1秒 | GPU需要传输，CPU直接使用 |
| **5. 优化循环** | 1000次迭代 | **~8-15分钟** | **~30-60分钟** | 主要耗时，取决于收敛速度 |
| **6. 验证** | 检查结果 | ~1秒 | ~1秒 | 快速验证 |
| **7. 保存** | 保存深度图 | ~5秒 | ~5秒 | 4个npy文件 |
| **总计** | 完整流程 | **~10-20分钟** | **~35-70分钟** | GPU快3-4倍 |

### 优化循环详细耗时（单次迭代）

| 操作 | GPU耗时 | CPU耗时 | 说明 |
|------|---------|---------|------|
| 深度重参数化（4个视角） | ~0.05秒 | ~0.2秒 | Spline变换 + SH缩放 |
| 几何一致性损失计算 | ~0.03秒 | ~0.15秒 | 6个视角对（4选2）的P2R和深度损失 |
| 正则化损失计算 | ~0.01秒 | ~0.05秒 | 先验 + 平滑 + 缩放约束 |
| 反向传播 | ~0.1秒 | ~0.5秒 | 计算所有参数的梯度 |
| 梯度裁剪 | ~0.01秒 | ~0.01秒 | 防止梯度爆炸 |
| 优化步骤 | ~0.01秒 | ~0.05秒 | Adam更新参数 |
| **单次迭代总计** | **~0.2秒** | **~1.0秒** | 每10次迭代打印一次进度 |

### 收敛情况估算

| 收敛情况 | 迭代次数 | GPU耗时 | CPU耗时 |
|----------|----------|---------|---------|
| **快速收敛** | 200-300次 | ~1-2分钟 | ~5-8分钟 |
| **正常收敛** | 500-700次 | ~3-5分钟 | ~10-15分钟 |
| **慢速收敛** | 800-1000次 | ~8-15分钟 | ~30-60分钟 |
| **不收敛** | 达到最大迭代 | ~15-20分钟 | ~60-70分钟 |

## 当前配置参数

```python
# 优化配置（已调整）
lambda_p2r = 2.0          # Point-to-Ray 损失权重（增强几何约束）
lambda_depth = 0.1        # 深度一致性损失权重
lambda_prior = 0.5        # 先验锚点损失权重（降低对DAP的依赖）
lambda_smooth = 0.01      # 平滑正则损失权重
lambda_scale = 0.01       # 方向变形约束损失权重
lr = 5e-4                 # 学习率（精细优化）
max_iter = 1000           # 最大迭代次数
early_stop_threshold = 1e-7  # 收敛阈值（更严格）
print_interval = 10       # 每10次迭代打印一次
```

## 性能优化建议

### 1. 如果GPU内存不足
- 降低图像分辨率（如果可能）
- 减少同时处理的pano数量
- 使用CPU模式（但会慢3-4倍）

### 2. 如果优化太慢
- 减少最大迭代次数（如500次）
- 增加学习率（如1e-3，但可能不稳定）
- 减少视角对数量（但会降低几何一致性）

### 3. 如果未完全收敛
- **损失还在下降** → 增加 `max_iter` 到 2000
- **损失已收敛但未完全重合** → 增加 `lambda_p2r` 到 5.0-10.0
- **损失震荡** → 降低学习率到 1e-4

## 监控指标

### 关键输出信息
```
Iter X/1000: total=0.066659, p2r=0.000000, prior=0.014747
```
- `total`: 总损失（应该单调下降）
- `p2r`: Point-to-Ray 损失（几何一致性，应该接近0）
- `prior`: 先验损失（防止过度偏离DAP）

### 收敛判断
- **能量变化率** < `early_stop_threshold` (1e-7) → 提前停止
- **p2r损失** < 0.001 → 几何一致性良好
- **总损失** 不再下降 → 可能已收敛

## 输出文件

### 中间结果（可选）
- `intermediate/bridgeb_optimization/view_{i}_iter_{N}.npy` - 每50次迭代保存一次

### 最终结果
- `outputs/aligned_depths/BridgeB/{pano_name}_aligned.npy` - 优化后的深度图

## 典型运行时间（BridgeB场景，4个pano）

| 设备 | 快速收敛 | 正常收敛 | 慢速收敛 | 不收敛 |
|------|----------|----------|----------|--------|
| **GPU** | 10-12分钟 | 15-20分钟 | 20-25分钟 | 25-30分钟 |
| **CPU** | 35-45分钟 | 50-70分钟 | 70-90分钟 | 90-120分钟 |

## 注意事项

1. **首次运行**：可能需要更长时间（模型初始化、GPU预热）
2. **内存使用**：GPU需要 ~2-4GB，CPU需要 ~4-8GB
3. **磁盘空间**：每个深度图 ~7MB，4个pano约30MB
4. **收敛速度**：取决于初始深度质量和相机位姿精度
